# Step2の指示内容

これから Step2（設計フェーズ）を進めたいです。  
基本方針は `docs/今後の方針.md` と `app/core/prompts.py` に書かれている内容に従います。

**重要な制約：**

- まだ実装コード（`.py` の中身）は書き換えないでください。
- いまは「仕様・設計メモ」を **Markdown** でまとめるだけにしてください。

やってほしいことは次の3つです。

---

## 【タスク1：prompts.py の仕様要約】

1. `app/core/prompts.py` を読み、以下の3つについて、

   - `build_mc_prompt_direct`
   - `build_mc_prompt_cot`
   - 内部ヘルパ `_format_choices`

   それぞれについて、次の点を日本語で箇条書きに要約してください。

   - 引数
   - 戻り値
   - 生成されるプロンプト構造  
     （Background / Question / Choices / 指示文 / 出力フォーマット）

2. すでに決めている運用仕様は以下です。  
   この仕様と `prompts.py` の実装が整合しているかを確認し、**問題なさそうかコメント**してください。

   - 4択問題はすべて小文字 `"a"`〜`"d"` のキーで扱う。
   - `lawqa_jp` の `question`, `choices` をそのまま渡す。
   - `context` には RAG からの条文テキスト（または `None`）を渡す。
   - **direct モード**では LLM 出力は **1文字のみ（a〜d）** を想定する。
   - **CoT モード**では、次の2行構成で出力させる。
     - `Reasoning: ...`
     - `Answer: c`

3. 上記を踏まえて、  
   「`prompts.py` はこの仕様で確定して良い」という前提であれば、その旨を明記してください。  
   問題点があれば、その指摘と改善案も書いてください。

---

## 【タスク2：Fine-tuning 用 JSONL フォーマットの設計】

次に、法令4択問題の Fine-tuning 用データを JSONL で保存するための仕様を文章で設計してください。

**前提：**

- 1レコードは必ず `"input"` / `"output"` / `"meta"` の3キーを持つ。
- `"input"` は必ず `app/core/prompts.py` の関数から生成するプロンプト文字列とする。
- `"output"` には以下の2パターンがある。
  - **direct モード**：小文字1文字だけ（例: `"c"`）
  - **cot モード**：`Reasoning` と `Answer` を含むテキスト。
- `"meta"` は学習には使わないが、分析用に情報を持たせたい。

**お願いしたいこと：**

1. `"input"` / `"output"` / `"meta"` のそれぞれについて、どんな情報を入れるかを日本語で仕様化してください。
   - 特に `"meta"` には最低限どのキー（例: `id`, `dataset`, `mode`, `correct`, `use_context`, `top_k` など）を入れるべきかを提案してください。

2. 上記仕様に基づいて、

   - **direct モード用のサンプル1レコード**
   - **cot モード用のサンプル1レコード**

   を、それぞれ JSON 形式の例として書いてください（ダミー値で構いません）。

> ※ まだ実際の JSONL ファイルは作成しないでください。  
> あくまで「仕様＋サンプル例」を Markdown 上で提示するだけにしてください。

---

## 【タスク3：build_finetune_dataset.py の関数設計】

最後に、`scripts/build_finetune_dataset.py` を新規追加すると仮定して、  
どんな関数を持たせるか、**インターフェース設計だけ**を行ってください。

**前提：**

- 元データとして `lawqa_jp` の4択問題を使う想定です。
- `RAGPipeline` を使って `context`（条文テキスト）を取得できます。
- `prompts.py` の関数で `input` を組み立て、タスク2で決めた JSONL 仕様に合わせてレコードを作ります。
- 学習ループは別のスクリプトで書くため、このファイルの責務は **「データ生成のみ」** です。

**お願いしたいこと：**

1. `scripts/build_finetune_dataset.py` に用意すべき関数一覧を箇条書きで提案してください。  
   例（あくまで例なので、必要なら変えてください）：

   - `load_lawqa(...)`
   - `build_context(...)`
   - `make_instance(...)`
   - `build_dataset(...)`
   - `save_jsonl(...)`
   - `main(...)`

2. 各関数ごとに、次の情報を Markdown で詳しく書いてください。

   - 目的
   - 引数（型イメージ）
   - 戻り値（型イメージ）
   - どの既存コンポーネント（`RAGPipeline`, `prompts.py` など）を使うか

3. 最後に、これらの関数をどう組み合わせれば  
   「`lawqa_jp` → RAG → JSONL」 のパイプラインになるか、  
   処理フローを番号付きリストでまとめてください。

> ※ ここでは `.py` ファイルはまだ作成しないでください。  
> ※ 仕様が十分に決まった段階で、次のステップとして実装を依頼します。

---

以上をすべて **1つの Markdown ドキュメントとして**出力してください。
